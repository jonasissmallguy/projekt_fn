<!DOCTYPE html>
<html>

<head>
    <title>Country Information</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="/components/navbar/navbar.css">
    <link rel="stylesheet" href="/components/footer/footer.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">;
    <!-- <script rel = "module" src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"
        integrity="sha512-UnrKxsCMN9hFk7M56t4I4ckB4N/2HHi0w/7+B/1JsXIX3DmyBcsGpT3/BsuZMZf+6mAr0vP81syWtfynHJ69JA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
        integrity="sha512-Qlv6VSKh1gDKGoJbnyA5RMXYcvnpIqhO++MhIM2fStMcGT9i2T//tSwYFlcyoRRDcDZ+TYHpH8azBBCyhpSeqw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        .country-header {
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .country-flag {
            max-width: 150px;
            margin-bottom: 15px;
        }

        .country-name {
            margin: 10px 0;
            color: #333;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px;
            text-align: center;
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        .tooltip {
            position: absolute;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .labels {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>
    <div id="country-info">
        <div class="country-header">
            <!-- Flag and name will be inserted here -->
        </div>

        <div id="visualizations">
            <!-- D3 visualization will be inserted here -->
        </div>
    </div>


    <script type="module">
        import { initializePage } from '/js/utils/pageLoader.js';
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>


    <script type="module">




        async function loadCountryData() {
            const urlParams = new URLSearchParams(window.location.search);
            const countryId = urlParams.get('id');

            if (!countryId) {
                console.error('No country specified');
                return;
            }

            try {
                const response = await fetch(`/api/countries/${countryId}`);
                if (!response.ok) throw new Error('Country not found');

                const countryData = await response.json();
                displayCountryHeader(countryData[0]); // Use first item for country info
                createVisualizations(countryData);
            } catch (error) {
                console.error('Error loading country data:', error);
            }
        }

        function displayCountryHeader(countryData) {
            const header = document.querySelector('.country-header');

            header.innerHTML = '';

            const flagImg = document.createElement('img');
            flagImg.className = 'country-flag';
            flagImg.src = `/images/flags/${countryData.country_iso.toLowerCase()}.png`;
            flagImg.alt = `Flag of ${countryData.country_name}`;

            flagImg.onerror = function () {
                this.src = '/images/flags/placeholder.png';
            };

            const nameH1 = document.createElement('h1');
            nameH1.className = 'country-name';
            nameH1.textContent = countryData.country_name;

            header.appendChild(flagImg);
            header.appendChild(nameH1);

            document.title = `${countryData.country_name} - Country Page`;
        }

        function createVisualizations(countryData) {
            const visualizations = document.getElementById('visualizations');
            visualizations.innerHTML = `
    
                <div class="chart-container">
                    <div class="padding1">
                <div id="giniChart" class="chart">
                    <div class="padding2">
                    <h3>Gini Coefficient Over Time</h3> 
                    <div class="chart-content"></div>
                    </div>
                    
                    <button
                        type="button"
                        class="btn btn-primary"
                        id="giniDownloadButton"
                    >
                        <i class="bi bi-download"></i> 
                        Download
                    </button>
                <div id="fertilityChart" class="chart">
                    <h3>Fertility Rate Trends</h3>
                    <div class="chart-content"></div>
                    </div>
                    <button
                        type="button"
                        class="btn btn-primary"
                        id="fertilityDownloadButton"
                    >
                        <i class="bi bi-download"></i> 
                        Download
                    </button>
                <div id="gdpChart" class="chart">
                    <h3>GDP per capital</h3>
                    <div class="chart-content"></div>
                    </div>
                    <button
                        type="button"
                        class="btn btn-primary"
                        id= "GDPDownloadButton"
                    >
                        <i class="bi bi-download"></i> 
                        Download
                    </button>
            </div>
            `;


            const timeData = countryData
                .map(d => ({
                    year: parseInt(d.year),
                    gini: parseFloat(d.gini),
                    palma: parseFloat(d.palma_ratio),
                    avg_continent_gini: parseFloat(d.continent_avg_gini),
                    fertility: parseFloat(d.fertility_rate),
                    avg_continent_fertility: parseFloat(d.continent_avg_fertility),
                    gdp_citizen: parseFloat(d.gdp_per_citizen),
                    avg_continent_gdp_citizen: parseFloat(d.continent_avg_gdp_per_citizen),
                    country: d.country_name,
                    continent: d.continent_name

                }))
                .sort((a, b) => a.year - b.year);

            createGiniChart(timeData);
            createFertilityChart(timeData);
            createGDPcitizenChart(timeData);
            CreateDownloadButtonEventHandlers(timeData);
        }

        function createGiniChart(data) {
            const margin = { top: 40, right: 120, bottom: 50, left: 60 };
            const width = 980 - margin.left - margin.right;
            const height = 520 - margin.top - margin.bottom;

            const svg = d3.select("#giniChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain(d3.extent(data, d => d.year))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([
                    d3.min(data, d => Math.min(d.gini, d.avg_continent_gini)) * 0.9,
                    d3.max(data, d => Math.max(d.gini, d.avg_continent_gini)) * 1.1
                ])
                .range([height, 0]);

            // X axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d3.format("d"))
                    .ticks(data.length))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");

            //title
            svg.append("text")
                .attr("x", 0)
                .attr("y", -5)
                .attr("text-anchor", "left")
                .style("font-size", "16px")
                .style("font-family", "Verdana, Geneva, Tahoma, sans-serif")
                .text("Udvikling i gini-koefficienten")

            // Y axis
            svg.append("g")
                .call(d3.axisLeft(y)
                    .tickFormat(d => d));

            // Create the line
            const line_country = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.gini));

            // Create the benchmark line
            const line_benchmark = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.avg_continent_gini));

            // Add path for country_line
            const path_country = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "darkblue")
                .attr("stroke-width", 2)
                .attr("d", line_country);

            // Animate the country line
            const path_countryLength = path_country.node().getTotalLength();
            path_country
                .attr("stroke-dasharray", path_countryLength)
                .attr("stroke-dashoffset", path_countryLength)
                .transition()
                .duration(2000)
                .attr("stroke-dashoffset", 0);

            // Create the benchmark line path
            const benchmarkPath = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line_benchmark);

            // Animate the benchmark line
            const benchmarkPathLength = benchmarkPath.node().getTotalLength();
            benchmarkPath
                .attr("stroke-dasharray", benchmarkPathLength)
                .attr("stroke-dashoffset", benchmarkPathLength)
                .transition()
                .duration(2000)
                .attr("stroke-dashoffset", 0);

            //Tool tips
            // Add tooltip div to the body
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "1px solid #ddd")
                .style("padding", "10px");

            // Add invisible hover areas for both lines
            const hover_country = svg.append("path")
                .datum(data)
                .attr("class", "hover-area")
                .attr("fill", "none")
                .attr("stroke", "transparent")
                .attr("stroke-width", 20)
                .attr("d", line_country)
                .on("mousemove", function (event) {
                    const [xPos] = d3.pointer(event);
                    const bisect = d3.bisector(d => d.year).left;
                    const x0 = x.invert(xPos);
                    const i = bisect(data, x0);
                    const d = data[i];

                    tooltip.style("opacity", 1)
                        .html(`Year: ${d.year}<br>Value: ${d.gini}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            // Repeat for benchmark line
            const hover_benchmark = svg.append("path")
                .datum(data)
                .attr("class", "hover-area")
                .attr("fill", "none")
                .attr("stroke", "transparent")
                .attr("stroke-width", 20)
                .attr("d", line_benchmark)
                .on("mousemove", function (event) {
                    const [xPos] = d3.pointer(event);
                    const bisect = d3.bisector(d => d.year).left;
                    const x0 = x.invert(xPos);
                    const i = bisect(data, x0);
                    const d = data[i];

                    tooltip.style("opacity", 1)
                        .html(`Year: ${d.year}<br>Value: ${d.avg_continent_gini}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));


            // Add circles that will follow the lines
            const focusCountry = svg.append("circle")
                .attr("r", 5)
                .attr("fill", "darkblue")
                .style("opacity", 0);

            const focusBenchmark = svg.append("circle")
                .attr("r", 5)
                .attr("fill", "steelblue")
                .style("opacity", 0);

            // Update the mousemove handlers
            hover_country.on("mousemove", function (event) {
                const [xPos] = d3.pointer(event);
                const bisect = d3.bisector(d => d.year).left;
                const x0 = x.invert(xPos);
                const i = bisect(data, x0);
                const d = data[i];

                focusCountry
                    .style("opacity", 1)
                    .attr("cx", x(d.year))
                    .attr("cy", y(d.gini));

                tooltip.style("opacity", 1)
                    .html(`Year: ${d.year}<br>Value: ${d.gini}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
                .on("mouseout", () => {
                    focusCountry.style("opacity", 0);
                    tooltip.style("opacity", 0);
                });

            hover_benchmark.on("mousemove", function (event) {
                const [xPos] = d3.pointer(event);
                const bisect = d3.bisector(d => d.year).left;
                const x0 = x.invert(xPos);
                const i = bisect(data, x0);
                const d = data[i];

                focusBenchmark
                    .style("opacity", 1)
                    .attr("cx", x(d.year))
                    .attr("cy", y(d.avg_continent_gini));

                tooltip.style("opacity", 1)
                    .html(`Year: ${d.year}<br>Value: ${d.avg_continent_gini}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
                .on("mouseout", () => {
                    focusBenchmark.style("opacity", 0);
                    tooltip.style("opacity", 0);
                });

            // Then for the labels:
            const lastPoint = data[data.length - 1];

            svg.append("text")
                .attr("class", "labels")
                .attr("x", width) // Position at full width
                .attr("y", y(lastPoint.gini))
                .attr("dx", "0.5em") // Add small offset
                .attr("dominant-baseline", "middle")
                .attr("fill", "darkblue")
                .text(lastPoint.country)
                .style("opacity", 0)
                .transition()
                .delay(1500)
                .style("opacity", 1);

            svg.append("text")
                .attr("class", "labels")
                .attr("x", width)
                .attr("y", y(lastPoint.avg_continent_gini))
                .attr("dx", "0.5em")
                .attr("dominant-baseline", "middle")
                .attr("fill", "steelblue")
                .text(lastPoint.continent)
                .style("opacity", 0)
                .transition()
                .delay(1500)
                .style("opacity", 1);
        }

        function createFertilityChart(data) {
            const margin = { top: 40, right: 120, bottom: 50, left: 60 };
            const width = 980 - margin.left - margin.right;
            const height = 520 - margin.top - margin.bottom;

            const svg = d3.select("#fertilityChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain(d3.extent(data, d => d.year))
                .range([0, width]);

            //scale on min/max of fertility or continent fertility
            const y = d3.scaleLinear()
                .domain([
                    d3.min(data, d => Math.min(d.fertility, d.avg_continent_fertility)) * 0.9,
                    d3.max(data, d => Math.max(d.fertility, d.avg_continent_fertility)) * 1.1
                ])
                .range([height, 0]);

            // X axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d3.format("d"))
                    .ticks(data.length))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");

            svg.append("text")
                .attr("x", 0)
                .attr("y", -5)
                .attr("text-anchor", "left")
                .style("font-size", "16px")
                .text("Udvikling i fertilitets-raten")

            // Y axis
            svg.append("g")
                .call(d3.axisLeft(y)
                    .tickFormat(d => d));

            // Create the line
            const line_country = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.fertility));

            // Create the benchmark line
            const line_benchmark = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.avg_continent_fertility));

            // Add path for country_line
            const path_country = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "darkblue")
                .attr("stroke-width", 2)
                .attr("d", line_country);

            // Animate the country line
            const path_countryLength = path_country.node().getTotalLength();
            path_country
                .attr("stroke-dasharray", path_countryLength)
                .attr("stroke-dashoffset", path_countryLength)
                .transition()
                .duration(2000)
                .attr("stroke-dashoffset", 0);

            // Create the benchmark line path
            const benchmarkPath = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line_benchmark);

            // Animate the benchmark line
            const benchmarkPathLength = benchmarkPath.node().getTotalLength();
            benchmarkPath
                .attr("stroke-dasharray", benchmarkPathLength)
                .attr("stroke-dashoffset", benchmarkPathLength)
                .transition()
                .duration(2000)
                .attr("stroke-dashoffset", 0);

            //Tool tips
            // Add tooltip div to the body
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "1px solid #ddd")
                .style("padding", "10px");

            // Add invisible hover areas for both lines
            const hover_country = svg.append("path")
                .datum(data)
                .attr("class", "hover-area")
                .attr("fill", "none")
                .attr("stroke", "transparent")
                .attr("stroke-width", 20)
                .attr("d", line_country)
                .on("mousemove", function (event) {
                    const [xPos] = d3.pointer(event);
                    const bisect = d3.bisector(d => d.year).left;
                    const x0 = x.invert(xPos);
                    const i = bisect(data, x0);
                    const d = data[i];

                    tooltip.style("opacity", 1)
                        .html(`Year: ${d.year}<br>Value: ${d.fertility}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            // Repeat for benchmark line
            const hover_benchmark = svg.append("path")
                .datum(data)
                .attr("class", "hover-area")
                .attr("fill", "none")
                .attr("stroke", "transparent")
                .attr("stroke-width", 20)
                .attr("d", line_benchmark)
                .on("mousemove", function (event) {
                    const [xPos] = d3.pointer(event);
                    const bisect = d3.bisector(d => d.year).left;
                    const x0 = x.invert(xPos);
                    const i = bisect(data, x0);
                    const d = data[i];

                    tooltip.style("opacity", 1)
                        .html(`Year: ${d.year}<br>Value: ${d.avg_continent_fertility}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));


            // Add circles that will follow the lines
            const focusCountry = svg.append("circle")
                .attr("r", 5)
                .attr("fill", "darkblue")
                .style("opacity", 0);

            const focusBenchmark = svg.append("circle")
                .attr("r", 5)
                .attr("fill", "steelblue")
                .style("opacity", 0);

            // Update the mousemove handlers
            hover_country.on("mousemove", function (event) {
                const [xPos] = d3.pointer(event);
                const bisect = d3.bisector(d => d.year).left;
                const x0 = x.invert(xPos);
                const i = bisect(data, x0);
                const d = data[i];

                focusCountry
                    .style("opacity", 1)
                    .attr("cx", x(d.year))
                    .attr("cy", y(d.fertility));

                tooltip.style("opacity", 1)
                    .html(`Year: ${d.year}<br>Value: ${d.fertility}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
                .on("mouseout", () => {
                    focusCountry.style("opacity", 0);
                    tooltip.style("opacity", 0);
                });

            hover_benchmark.on("mousemove", function (event) {
                const [xPos] = d3.pointer(event);
                const bisect = d3.bisector(d => d.year).left;
                const x0 = x.invert(xPos);
                const i = bisect(data, x0);
                const d = data[i];

                focusBenchmark
                    .style("opacity", 1)
                    .attr("cx", x(d.year))
                    .attr("cy", y(d.avg_continent_fertility));

                tooltip.style("opacity", 1)
                    .html(`Year: ${d.year}<br>Value: ${d.avg_continent_fertility}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
                .on("mouseout", () => {
                    focusBenchmark.style("opacity", 0);
                    tooltip.style("opacity", 0);
                });

            // Then for the labels:
            const lastPoint = data[data.length - 1];

            svg.append("text")
                .attr("class", "labels")
                .attr("x", width) // Position at full width
                .attr("y", y(lastPoint.fertility))
                .attr("dx", "0.5em") // Add small offset
                .attr("dominant-baseline", "middle")
                .attr("fill", "darkblue")
                .text(lastPoint.country)
                .style("opacity", 0)
                .transition()
                .delay(1500)
                .style("opacity", 1);

            svg.append("text")
                .attr("class", "labels")
                .attr("x", width)
                .attr("y", y(lastPoint.avg_continent_fertility))
                .attr("dx", "0.5em")
                .attr("dominant-baseline", "middle")
                .attr("fill", "steelblue")
                .text(lastPoint.continent)
                .style("opacity", 0)
                .transition()
                .delay(1500)
                .style("opacity", 1);
        }


        function createGDPcitizenChart(data) {
            const margin = { top: 40, right: 120, bottom: 50, left: 60 };
            const width = 980 - margin.left - margin.right;
            const height = 520 - margin.top - margin.bottom;

            const svg = d3.select("#gdpChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain(d3.extent(data, d => d.year))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([
                    d3.min(data, d => Math.min(d.gdp_citizen, d.avg_continent_gdp_citizen)) * 0.9,
                    d3.max(data, d => Math.max(d.gdp_citizen, d.avg_continent_gdp_citizen)) * 1.1
                ])
                .range([height, 0]);


            // X axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d3.format("d"))
                    .ticks(data.length))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");


            svg.append("text")
                .attr("x", 0)
                .attr("y", -5)
                .attr("text-anchor", "left")
                .style("font-size", "16px")
                .text("Change in GDP/citizen (USD)")

            // Y axis
            svg.append("g")
                .call(d3.axisLeft(y)
                    .tickFormat(d => d));

            // Create the line
            const line_country = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.gdp_citizen));

            // Create the benchmark line
            const line_benchmark = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.avg_continent_gdp_citizen));

            // Add path for country_line
            const path_country = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "darkblue")
                .attr("stroke-width", 2)
                .attr("d", line_country);

            // Animate the country line
            const path_countryLength = path_country.node().getTotalLength();
            path_country
                .attr("stroke-dasharray", path_countryLength)
                .attr("stroke-dashoffset", path_countryLength)
                .transition()
                .duration(2000)
                .attr("stroke-dashoffset", 0);

            // Create the benchmark line path
            const benchmarkPath = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line_benchmark);

            // Animate the benchmark line
            const benchmarkPathLength = benchmarkPath.node().getTotalLength();
            benchmarkPath
                .attr("stroke-dasharray", benchmarkPathLength)
                .attr("stroke-dashoffset", benchmarkPathLength)
                .transition()
                .duration(2000)
                .attr("stroke-dashoffset", 0);



            //Tool tips
            // Add tooltip div to the body
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "1px solid #ddd")
                .style("padding", "10px");

            // Add invisible hover areas for both lines
            const hover_country = svg.append("path")
                .datum(data)
                .attr("class", "hover-area")
                .attr("fill", "none")
                .attr("stroke", "transparent")
                .attr("stroke-width", 20)
                .attr("d", line_country)
                .on("mousemove", function (event) {
                    const [xPos] = d3.pointer(event);
                    const bisect = d3.bisector(d => d.year).left;
                    const x0 = x.invert(xPos);
                    const i = bisect(data, x0);
                    const d = data[i];

                    tooltip.style("opacity", 1)
                        .html(`Year: ${d.year}<br>Value: ${d.gdp_per_citizen}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            // Repeat for benchmark line
            const hover_benchmark = svg.append("path")
                .datum(data)
                .attr("class", "hover-area")
                .attr("fill", "none")
                .attr("stroke", "transparent")
                .attr("stroke-width", 20)
                .attr("d", line_benchmark)
                .on("mousemove", function (event) {
                    const [xPos] = d3.pointer(event);
                    const bisect = d3.bisector(d => d.year).left;
                    const x0 = x.invert(xPos);
                    const i = bisect(data, x0);
                    const d = data[i];

                    tooltip.style("opacity", 1)
                        .html(`Year: ${d.year}<br>Value: ${d.avg_continent_gdp_citizen}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));


            // Add circles that will follow the lines
            const focusCountry = svg.append("circle")
                .attr("r", 5)
                .attr("fill", "darkblue")
                .style("opacity", 0);

            const focusBenchmark = svg.append("circle")
                .attr("r", 5)
                .attr("fill", "steelblue")
                .style("opacity", 0);

            // Update the mousemove handlers
            hover_country.on("mousemove", function (event) {
                const [xPos] = d3.pointer(event);
                const bisect = d3.bisector(d => d.year).left;
                const x0 = x.invert(xPos);
                const i = bisect(data, x0);
                const d = data[i];

                focusCountry
                    .style("opacity", 1)
                    .attr("cx", x(d.year))
                    .attr("cy", y(d.gdp_citizen));

                tooltip.style("opacity", 1)
                    .html(`Year: ${d.year}<br>Value: ${d.gdp_citizen}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
                .on("mouseout", () => {
                    focusCountry.style("opacity", 0);
                    tooltip.style("opacity", 0);
                });

            hover_benchmark.on("mousemove", function (event) {
                const [xPos] = d3.pointer(event);
                const bisect = d3.bisector(d => d.year).left;
                const x0 = x.invert(xPos);
                const i = bisect(data, x0);
                const d = data[i];

                focusBenchmark
                    .style("opacity", 1)
                    .attr("cx", x(d.year))
                    .attr("cy", y(d.avg_continent_gdp_citizen));

                tooltip.style("opacity", 1)
                    .html(`Year: ${d.year}<br>Value: ${d.avg_continent_gdp_citizen}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
                .on("mouseout", () => {
                    focusBenchmark.style("opacity", 0);
                    tooltip.style("opacity", 0);
                });

            // Then for the labels:
            const lastPoint = data[data.length - 1];

            svg.append("text")
                .attr("class", "labels")
                .attr("x", width) // Position at full width
                .attr("y", y(lastPoint.gdp_citizen))
                .attr("dx", "0.5em") // Add small offset
                .attr("dominant-baseline", "middle")
                .attr("fill", "darkblue")
                .text(lastPoint.country)
                .style("opacity", 0)
                .transition()
                .delay(1500)
                .style("opacity", 1);

            svg.append("text")
                .attr("class", "labels")
                .attr("x", width)
                .attr("y", y(lastPoint.avg_continent_gdp_citizen))
                .attr("dx", "0.5em")
                .attr("dominant-baseline", "middle")
                .attr("fill", "steelblue")
                .text(lastPoint.continent)
                .style("opacity", 0)
                .transition()
                .delay(1500)
                .style("opacity", 1);
        }

        function CreateDownloadButtonEventHandlers(graphData) {

                let giniDownloadButton = document.getElementById('giniDownloadButton');
                let fertilityDownloadButton = document.getElementById('fertilityDownloadButton');
                let GDPDownloadButton = document.getElementById('GDPDownloadButton');

                giniDownloadButton.addEventListener("click", async (event) => {

                    console.log("ginidownloadbutton event was triggered");

                    const workbook = generateWorkbookWithHeadersAndData(['year', 'gini', 'avg_continent_gini', 'country', 'continent'], graphData, giniDownloadButton.id)

                    const buffer = await workbook.xlsx.writeBuffer();

                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `GiniData_${graphData[0].country}.xlsx`;

                    link.click();

                    URL.revokeObjectURL(link.href);
                    console.log("File was saved to user's PC");


                });

                fertilityDownloadButton.addEventListener("click", async (event) => {

                    console.log("fertilityDownloadButton event was triggered");

                    const workbook = generateWorkbookWithHeadersAndData(['year', 'fertility', 'avg_continent_fertility', 'country', 'continent'], graphData, fertilityDownloadButton.id);
                    workbook.title = 'Fertility Data'
                    const buffer = await workbook.xlsx.writeBuffer();

                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `Fertility_Data_${graphData[0].country}.xlsx`;

                    link.click();

                    URL.revokeObjectURL(link.href);
                    console.log("File was saved to user's PC");


                });
                GDPDownloadButton.addEventListener("click", async (event) => {

                    console.log("GDPDownloadButton event was triggered");

                    const workbook = generateWorkbookWithHeadersAndData(['year', 'gdp', 'gdp_citizen', 'avg_continent_gdp_citizen', 'country', 'continent'], graphData, GDPDownloadButton.id)

                    const buffer = await workbook.xlsx.writeBuffer();

                    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `GiniData_${graphData[0].country}.xlsx`;

                    link.click();

                    URL.revokeObjectURL(link.href);
                    console.log("File was saved to user's PC");


                });

            }

            function generateWorkbookWithHeadersAndData(headerArray, graphData, htmlElementId) {
                const ExcelJS = window.ExcelJS;
                const workbook = new ExcelJS.Workbook();

                workbook.creator = 'DownloadedByUser';

                const graphDataSheet = workbook.addWorksheet('Graph data');
                const aboutDataSheet = workbook.addWorksheet('About Data');

                graphDataSheet.columns = headerArray.map(headeritem => ({
                    header: headeritem,
                    key: headeritem
                }));

                aboutDataSheet.columns = headerArray.map(headeritem => ({
                    header: headeritem,
                    key: headeritem
                }));

                graphData.forEach(element => {
                    switch (htmlElementId) {
                        case 'fertilityDownloadButton':
                            graphDataSheet.addRow({
                                year: element.year,
                                fertility: element.fertility,
                                avg_continent_fertility: element.avg_continent_fertility,
                                country: element.country,
                                continent: element.continent
                            });
                            break;
                        case 'giniDownloadButton':
                            graphDataSheet.addRow({
                                year: element.year,
                                gini: element.gini,
                                avg_continent_gini: element.avg_continent_gini,
                                country: element.country,
                                continent: element.continent
                            });
                            break;
                        case 'GDPDownloadButton':
                            graphDataSheet.addRow({
                                year: element.year,
                                gdp: element.gdp,
                                gdp_citizen: element.gdp_citizen,
                                avg_continent_gdp_citizen: element.avg_continent_gdp_citizen,
                                country: element.country,
                                continent: element.continent
                            });
                            break;
                        default:
                            break;
                    }
                });

                return workbook;
            }

        

        document.addEventListener('DOMContentLoaded', loadCountryData);
    </script>

    <div id="footer-container"></div>

</body>

</html>