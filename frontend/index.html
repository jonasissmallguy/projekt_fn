<!DOCTYPE html>
<html>
<head>
    <title>World Economic Map</title>
    <link rel="stylesheet" href="/components/navbar/navbar.css">
    <link rel="stylesheet" href="/components/footer/footer.css">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        .map-container {
            width: 60%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        .country {
            stroke: #fff;
            stroke-width: 0.5;
            transition: all 0.2s;
        }
        
        .country:hover {
            stroke: #000;
            stroke-width: 1;
            cursor: pointer;
        }

        #map {
            margin-top: 20px;
            position: relative;
            box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
            box-shadow: inset;
        }

        .metric-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .metric-button {
            padding: 8px 20px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .metric-button.active {
            background: #007bff;
            color: white;
        }

        .timeline-controls {
            width: 80%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            text-align: center;
        }

        .play-button {
            padding: 8px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        #yearSlider {
            flex-grow: 1;
            height: 8px;
        }

        .year-display {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        #country-info {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 300px;
        }

        .info-heading {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .info-value {
            margin-bottom: 15px;
        }

        #view-more-btn {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #close-info {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
        }

        .content-wrapper {
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .left-column {
            padding-right: 40px;
        }

        .right-column {
            padding-top: 28px; /* Aligns with the main heading */
        }

        .tagline {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .main-term h1 {
            font-size: 24px;
            color: #333;
            margin: 0 0 16px 0;
            font-weight: normal;
        }

        .main-term p {
            color: #666;
            line-height: 1.6;
            margin: 0;
            font-size: 14px;
        }

        .term-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 24px;
            gap: 12px;
        }

        .icon-wrapper {
            background-color: #ffffff;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .icon-wrapper i {
            font-size: 16px;
            color: #666;
        }

        .term-content h2 {
            font-size: 16px;
            color: #333;
            margin: 0 0 4px 0;
            font-weight: normal;
        }

        .term-content p {
            color: #666;
            margin: 0;
            line-height: 1.4;
            font-size: 14px;
        }

        .icon-image {
        width: 50px;  
        height: 30px;
        object-fit: contain;
        }   

        .article-image {
        width: 100%; /* Ensures the image spans the full width of its container */
        height: 200px; /* Sets a consistent height for the image area */
        background-color: #f0f0f0; /* Placeholder background color */
        border-radius: 4px; /* Adds slight rounding for a polished look */
        margin-bottom: 15px; /* Adds spacing below the image */
        }

        h2 {
            font-size: 18px; /* Sets a readable font size */
            margin: 10px 0; /* Adds vertical spacing around the heading */
            color: #333; /* Uses a neutral dark color */
            font-weight: 500; /* Medium font weight for readability */
            text-align: center; /* Ensures the heading text is centered */
        }

        .map-container h1 {
            text-align: center; /* Centers the text within the container */
            margin-bottom: 20px; /* Adds spacing below the title */
        }
        
</style>
</head>
<body>
    <div id="navbar-container"></div>
    
    <div class="map-container">
        <h1>World Economic Inequality Map</h1>
        <div class="information">
            <p>World Bank, Poverty and Inequality Platform. Data based on primary household survey data.</p>
        </div>

        <div class="metric-toggle">
            <button class="metric-button active" data-metric="gini">GINI</button>
            <button class="metric-button" data-metric="palma">Palma</button>
        </div>

        <div class="timeline-controls">
            <button id="playButton" class="play-button">▶ Play</button>
            <div class="year-display">
                Year: <span id="currentYear">1990</span>
            </div>
            <div class="slider-container">
                <span>1990</span>
                <input type="range" id="yearSlider" min="1990" max="2017" value="1990" step="1">
                <span>2017</span>
            </div>
        </div>

        <div id="map"></div>
        <div id="legend" class="legend"></div>
        <div id="overlay"></div>


        <div id="country-info">
            <button id="close-info">&times;</button>
            <div class="info-heading">Country:</div>
            <div id="info-country" class="info-value"></div>
            <div class="info-heading">Year:</div>
            <div id="info-year" class="info-value"></div>
            <div class="info-heading">GINI:</div>
            <div id="info-gini" class="info-value"></div>
            <div class="info-heading">Palma Ratio:</div>
            <div id="info-palma" class="info-value"></div>
            <button id="view-more-btn">View more country data</button>
        </div>

        <div class="content-wrapper">
            <div class="left-column">
                <div class="main-term">
                    <h1>Uligheds-termer</h1>
                    <p>Lorem ipsum dolor sit amet et delectus accommodate his consul copiosae legendos at vix ad putent delectus delicata usu. Vidit dissentiet eos cu eum an brute copiosae hendrerit. Eos erant dolorum an.</p>
                </div>
            </div>
            
            <div class="right-column">
                <div class="term-container">
                    <div class="icon-wrapper">
                        <img src="./images/icons/gini.png" alt="Gini icon" class="icon-image">
                    </div>
                    <div class="term-content">
                        <h2>Gini-koefficienten</h2>
                        <p>Lorem ipsum dolor sit amet et delectus accommodate his consul copiosae.</p>
                    </div>
                </div>
            
                <div class="term-container">
                    <div class="icon-wrapper">
                        <img src="./images/icons/palma.png" alt="Palma icon" class="icon-image">
                    </div>
                    <div class="term-content">
                        <h2>Palma-raten</h2>
                        <p>Lorem ipsum dolor sit amet et delectus accommodate his consul copiosae.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const mapConfig = {
            width: 960,
            height: 500,
            initialYear: 1990
        };

        const metricConfig = {
            gini: {
                scale: d3.scaleSequential(d3.interpolateBlues).domain([20, 65]),
                legendValues: [20, 30, 40, 50, 60, 65],
                label: 'GINI: '
            },
            palma: {
                scale: d3.scaleSequential(d3.interpolateBlues).domain([0.5, 4]),
                legendValues: [0.5, 1, 1.5, 2, 3, 4],
                label: 'Palma: '
            }
        };

        let state = {
            currentMetric: 'gini',
            isPlaying: false,
            animationInterval: null,
            worldData: null,
            geoData: null,
            svg: null,
            path: null
        };

        // Core map functionality
        async function initializeMap() {
            state.svg = d3.select("#map")
                .append("svg")
                .attr("width", mapConfig.width)
                .attr("height", mapConfig.height);

            const projection = d3.geoMercator()
                .scale(120)
                .center([0, 20])
                .translate([mapConfig.width / 2, mapConfig.height / 2]);

            state.path = d3.geoPath().projection(projection);

            setupEventListeners();
            await loadData();
            updateVisualization(mapConfig.initialYear);
        }

        async function loadData() {
            try {
                const [geoData, economicData] = await Promise.all([
                    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
                    fetch('/api/world_data').then(res => res.json())
                ]);

                state.geoData = geoData;
                state.worldData = economicData.data;
                
                createLegend();
                setupTimeline();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateVisualization(year) {
            const yearData = state.worldData[year];
            const metric = metricConfig[state.currentMetric];

            state.svg.selectAll("path")
                .data(state.geoData.features)
                .join("path")
                .attr("d", state.path)
                .attr("class", "country")
                .transition()
                .duration(200)
                .attr("fill", d => {
                    const countryData = yearData?.[d.properties.name];
                    if (!countryData) return "#ccc";
                    const value = getMetricValue(countryData);
                    return !isNaN(value) ? metric.scale(value) : "#ccc";
                });

            // Update click handlers
            state.svg.selectAll("path")
                .on("click", (event, d) => {
                    const countryData = yearData?.[d.properties.name];
                    if (countryData) {
                        showCountryInfo(d.properties.name, countryData);
                    }
                });

            document.getElementById('currentYear').textContent = year;
        }

        // UI Components
        function createLegend() {
            const metric = metricConfig[state.currentMetric];
            const legend = d3.select("#legend").html("");
            
            metric.legendValues.forEach(value => {
                const div = legend.append("div")
                    .attr("class", "legend-item");
                
                div.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", metric.scale(value));
                
                div.append("span")
                    .text(`${metric.label}${value}`);
            });
        }

        function setupEventListeners() {
            // Metric toggle
            document.querySelectorAll('.metric-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.metric-button')
                        .forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state.currentMetric = e.target.dataset.metric;
                    createLegend();
                    updateVisualization(getCurrentYear());
                });
            });

            // Info box
            document.getElementById('close-info').onclick = closeInfoBox;
            document.getElementById('overlay').onclick = closeInfoBox;
        }

        function setupTimeline() {
            const slider = document.getElementById('yearSlider');
            const playButton = document.getElementById('playButton');

            slider.addEventListener('input', (e) => {
                updateVisualization(e.target.value);
            });

            playButton.addEventListener('click', togglePlay);
        }

        // Helper functions
        function getMetricValue(countryData) {
            return parseFloat(state.currentMetric === 'gini' ? 
                countryData.gini : countryData.palmaRatio);
        }

        function getCurrentYear() {
            return document.getElementById('yearSlider').value;
        }

        function showCountryInfo(countryName, countryData) {
            const giniValue = parseFloat(countryData.gini);
            const palmaValue = parseFloat(countryData.palmaRatio);

            document.getElementById('info-country').textContent = countryName;
            document.getElementById('info-year').textContent = getCurrentYear();
            document.getElementById('info-gini').textContent = 
                !isNaN(giniValue) ? giniValue.toFixed(1) : 'N/A';
            document.getElementById('info-palma').textContent = 
                !isNaN(palmaValue) ? palmaValue.toFixed(2) : 'N/A';

            document.getElementById('view-more-btn').onclick = (e) => {
                e.preventDefault();
                if (countryData.countryId) {
                    window.location.href = `/country.html?id=${countryData.countryId}`;
                }
            };

            document.getElementById('country-info').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeInfoBox() {
            document.getElementById('country-info').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function togglePlay() {
            if (state.isPlaying) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        function startAnimation() {
            const slider = document.getElementById('yearSlider');
            const playButton = document.getElementById('playButton');
            
            if (parseInt(slider.value) >= parseInt(slider.max)) {
                slider.value = slider.min;
                updateVisualization(slider.min);
            }

            state.isPlaying = true;
            playButton.textContent = '⏸ Pause';

            state.animationInterval = setInterval(() => {
                let year = parseInt(slider.value);
                if (year >= parseInt(slider.max)) {
                    stopAnimation();
                    return;
                }
                slider.value = ++year;
                updateVisualization(year);
            }, 1000);
        }

        function stopAnimation() {
            state.isPlaying = false;
            document.getElementById('playButton').textContent = '▶ Play';
            clearInterval(state.animationInterval);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            import('/js/utils/pageLoader.js').then(module => {
                module.initializePage();
            });
        });
    </script>

    <div class="card-container">
        <div class="card">
            <div class="image-placeholder"></div>
            <h3>Economical incidents</h3>
            <p>Timeline since 1980 describing the economical situation and how it affected the equality</p>
            <a href="#">Read more</a>
        </div>
        <div class="card">
            <div class="image-placeholder"></div>
            <h3>Countries buying power</h3>
            <p>How many people could live a day in Denmark?</p>
            <a href="#">Read more</a>
        </div>
        <div class="card">
            <div class="image-placeholder"></div>
            <h3>Article 3</h3>
            <p>Lorem ipsum dolor sit amet et delectus accommodare his consul copiosae.</p>
            <a href="#">Read more</a>
        </div>

    <div id="footer-container"></div>
</body>
</html>